FROM bde2020/spark-submit:3.1.1-hadoop3.2

LABEL maintainer="Eldar Kalachev <Eldar_Kalachev@epam.com>"

ARG spark_master_name
ARG spark_application_jar_class
ARG spark_master_port
ARG spark_application_main_class
ARG spark_application_args

ARG blob_read_account_name
ARG blob_read_container_name
ARG blob_read_container_key

ARG blob_write_account_name
ARG blob_write_container_name
ARG blob_write_container_key

ARG opencage_api_key

ENV SPARK_MASTER_NAME=${spark_master_name}

ENV SPARK_APPLICATION_JAR_NAME=${spark_application_jar_class}
ENV SPARK_MASTER_PORT=${spark_master_port}
ENV SPARK_APPLICATION_MAIN_CLASS=${spark_application_main_class}
ENV SPARK_APPLICATION_ARGS=${spark_application_args}

ENV BLOB_READ_ACCOUNT_NAME  $blob_read_account_name
ENV BLOB_READ_CONTAINER_NAME $blob_read_container_name
ENV BLOB_READ_CONTAINER_KEY $blob_read_container_key

ENV BLOB_WRITE_ACCOUNT_NAME $blob_write_account_name
ENV BLOB_WRITE_CONTAINER_NAME $blob_write_container_name
ENV BLOB_WRITE_CONTAINER_KEY $blob_write_container_key

ENV OPENCAGE_API_KEY   $opencage_api_key

COPY submit.sh /

RUN apk update && apk add dos2unix && dos2unix submit.sh

RUN apk add --no-cache openjdk8 maven\
      && chmod +x /submit.sh \
      && mkdir -p /app \
      && mkdir -p /usr/src/app

# Copy the POM-file first, for separate dependency resolving and downloading
COPY pom.xml /usr/src/app
RUN cd /usr/src/app \
      && mvn dependency:resolve
RUN cd /usr/src/app \
      && mvn verify

# Copy the source code and build the application
COPY . /usr/src/app
RUN cd /usr/src/app \
      && mvn clean package

ENV SPARK_APPLICATION_JAR_LOCATION="/usr/src/app/target/${SPARK_APPLICATION_JAR_NAME}.jar"

CMD ["/bin/bash", "/submit.sh"]